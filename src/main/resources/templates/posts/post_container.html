<div class="feed">
    <div th:each="post: ${posts}">
        <div class="card" th:id="'post-' + ${post.id}" th:data-post-id="${post.id}" th:data-liked="${post.liked}">
            <div class="card-top">
                <div class="poster-info">
                    <h3><span th:text="${post.nickname}"></span> posted</h3>
                    <h5 th:text="${post.timeSince(currentTime)}"></h5>
                </div>
                <p class="post-content" th:text="${post.content}"></p>
                <h5 th:id="'likes-string-' + ${post.id}" class="who-liked-this" th:text="${likesHandler.getLikedString(post.id, post.liked)}"></h5>

                <div class="comments-section hidden">
                    <div th:each="comment: ${commentsHandler.getCommentsWithData(post.id)}">
                        <h5 class="comment-header" th:text="${comment.nickname} + ' commented (' + ${comment.timeSince(currentTime)} + '):'"></h5>
                        <h6 class="comment-body" th:text="${comment.content}"></h6>
                    </div>
                    <div class="comment-box">
                        <form id="new-comment" class="form-post" th:action="@{/comments}" th:object="${comment}" method="POST">
                            <h3><i class="fa-regular fa-message"></i></h3>
                            <input type="hidden" th:attr="name='postId'" th:value="${post.id}">
                            <input type="hidden" th:attr="name='userId'" th:value="${#authentication.principal.attributes['sub']}">
                            <input type="hidden" th:attr="name='dateTime'" th:value="${currentTime}">
                            <input type="text"
                                   id="comment-input"
                                   class="input-post"
                                   th:field="*{comments}"
                                   th:placeholder="'Write a comment...'"
                            />
                        </form>

                    </div>
                </div>

            </div>
            <div class="card-bottom">
                <div class="icon-group like-group">
                    <a href="#" class="like-button"><i class="fa-regular fa-thumbs-up"></i></a>
                    <p>Like</p>
                </div>
                <div class="icon-group liked-group">
                    <a href="#" class="liked-button"><i class="fa-solid fa-thumbs-up"></i></a>
                    <p>Liked</p>
                </div>
                <div class="icon-group">
                    <a href="#" class="comments-button"><i class="fa-regular fa-comment"></i></a>
                    <p>Comments</p>
                </div>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        const protocol = window.location.protocol;
        const root = window.location.host;

        document.addEventListener('DOMContentLoaded', function() {
            const likeButtons = document.querySelectorAll('.like-button');

            likeButtons.forEach(likeButton => {
                const card = likeButton.closest('.card');
                const likeGroup = card.querySelector('.like-group');
                const likedGroup = card.querySelector('.liked-group');
                const likedButton = likedGroup.querySelector('.liked-button');
                const commentsButton = card.querySelector('.comments-button');
                const commentsSection = card.querySelector('.comments-section');

                const likedByUser = card.dataset.liked;
                const postId = card.dataset.postId;
                const likeString = document.getElementById(`likes-string-${postId}`)

                if (likedByUser == "true") {
                    likeGroup.classList.add('hidden');
                } else {
                    likedGroup.classList.add('hidden');
                }

                likeButton.addEventListener('click', function(event) {
                    event.preventDefault(); // Don't reload the page.

                    fetch(`${protocol}//${root}/likes/${postId}`, {
                        method: 'POST'
                    })
                    .then(response => response.text())
                    .then(newLikesText => {
                        likeString.textContent = newLikesText;
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });

                    likeGroup.classList.toggle('hidden');
                    likedGroup.classList.toggle('hidden');
                });

                likedButton.addEventListener('click', function(event) {
                    event.preventDefault(); // Don't reload the page.

                    fetch(`${protocol}//${root}/likes/${postId}`, {
                        method: 'DELETE'
                    })
                    .then(response => response.text())
                    .then(newLikesText => {
                        likeString.textContent = newLikesText;
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });

                    likeGroup.classList.toggle('hidden');
                    likedGroup.classList.toggle('hidden');
                });

                commentsButton.addEventListener('click', function(event) {
                    event.preventDefault(); // Don't reload the page.
                    commentsSection.classList.toggle('hidden');
                });

                document.getElementById('new-comment').addEventListener('submit', function(e) {
                    e.preventDefault(); // Prevent form submission

                    const formData = new FormData(this);

                    fetch(this.action, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(response => response.json())  // Expecting json response
                    .then(comment => {
                        const newComment = document.createElement('div');
                        newComment.innerHTML = `
                            <h5 class="comment-header">${comment.nickname} commented (${comment.timestring}):</h5>
                            <h6 class="comment-body">${comment.content}</h6>
                        `;

                        commentsSection.prepend(newComment);
                        document.getElementById('comment-input').value = '';
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
                });
            });
        });
    </script>
</div>